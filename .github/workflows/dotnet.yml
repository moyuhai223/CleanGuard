name: Build and Package

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - rid: win32
            platform_target: x86
          - rid: win64
            platform_target: x64

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Setup NuGet
        uses: NuGet/setup-nuget@v2

      - name: Restore packages
        run: nuget restore Src/CleanGuard_App/packages.config -PackagesDirectory packages -NonInteractive

      - name: Build (${{ matrix.rid }})
        shell: pwsh
        run: |
          msbuild Src/CleanGuard_App/CleanGuard_App.csproj `
            /t:Rebuild `
            /p:Configuration=Release `
            /p:Platform="AnyCPU" `
            /p:PlatformTarget=${{ matrix.platform_target }}

      - name: Generate version timestamp
        id: version
        shell: pwsh
        run: |
          $version = Get-Date -Format "yyyyMMddHHmmss"
          "version=$version" >> $env:GITHUB_OUTPUT

      - name: Package (${{ matrix.rid }})
        id: package
        shell: pwsh
        run: |
          $stage = "artifacts/stage-${{ matrix.rid }}"
          New-Item -ItemType Directory -Path $stage -Force | Out-Null

          $singleExe = "Output/CleanGuard_App.exe"
          if (-not (Test-Path $singleExe)) {
            throw "Single-file exe not found: $singleExe"
          }

          Copy-Item -Path $singleExe -Destination "$stage/CleanGuard.exe" -Force

          $config = "Output/CleanGuard_App.exe.config"
          if (Test-Path $config) {
            Copy-Item -Path $config -Destination "$stage/CleanGuard.exe.config" -Force
          }

          if (Test-Path "Output/x86/SQLite.Interop.dll") {
            New-Item -ItemType Directory -Path "$stage/x86" -Force | Out-Null
            Copy-Item -Path "Output/x86/SQLite.Interop.dll" -Destination "$stage/x86/SQLite.Interop.dll" -Force
          }

          if (Test-Path "Output/x64/SQLite.Interop.dll") {
            New-Item -ItemType Directory -Path "$stage/x64" -Force | Out-Null
            Copy-Item -Path "Output/x64/SQLite.Interop.dll" -Destination "$stage/x64/SQLite.Interop.dll" -Force
          }

          $sharpZipLib = "Output/ICSharpCode.SharpZipLib.dll"
          if (Test-Path $sharpZipLib) {
            Copy-Item -Path $sharpZipLib -Destination "$stage/ICSharpCode.SharpZipLib.dll" -Force
          }

          $zipName = "CleanGuard-${{ matrix.rid }}-${{ steps.version.outputs.version }}.zip"
          $zipPath = "artifacts/$zipName"
          if (Test-Path $zipPath) { Remove-Item $zipPath -Force }
          Compress-Archive -Path "$stage/*" -DestinationPath $zipPath

          "zip_name=$zipName" >> $env:GITHUB_OUTPUT
          "zip_path=$zipPath" >> $env:GITHUB_OUTPUT

      - name: Upload artifact (${{ matrix.rid }})
        uses: actions/upload-artifact@v4
        with:
          name: package-${{ matrix.rid }}-${{ steps.version.outputs.version }}
          path: ${{ steps.package.outputs.zip_path }}
          if-no-files-found: error

  release:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download packaged artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-assets

      - name: Update latest tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -f latest
          git push origin latest --force

      - name: Publish Release to latest tag
        uses: softprops/action-gh-release@v2
        with:
          tag_name: latest
          name: "Latest Build"
          files: release-assets/**/*.zip
          generate_release_notes: true
          prerelease: false
