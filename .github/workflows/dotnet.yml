name: Build and Release CleanGuard (Framework-dependent)

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          clean: false

      - name: Configure Git for UTF-8
        shell: pwsh
        run: |
          git config --global core.autocrlf false
          git config --global i18n.commitencoding utf-8
          git config --global i18n.logoutputencoding utf-8

      - name: Enable UTF-8 code page
        shell: pwsh
        run: |
          chcp 65001
          [Console]::OutputEncoding = [System.Text.Encoding]::UTF8

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Setup NuGet
        uses: NuGet/setup-nuget@v2

      - name: Restore dependencies
        run: nuget restore Src/CleanGuard_App/packages.config -PackagesDirectory packages -NonInteractive

      - name: Build project
        shell: pwsh
        run: |
          msbuild Src/CleanGuard_App/CleanGuard_App.csproj `
            /t:Rebuild `
            /p:Configuration=Release `
            /p:Platform="AnyCPU"

      - name: Prepare publish folder
        shell: pwsh
        run: |
          $publishDir = "publish"
          if (Test-Path $publishDir) {
            Remove-Item $publishDir -Recurse -Force
          }
          New-Item -ItemType Directory -Path $publishDir | Out-Null

          Copy-Item -Path "Output/CleanGuard_App.exe" -Destination "$publishDir/CleanGuard.exe" -Force

          if (Test-Path "Output/CleanGuard_App.exe.config") {
            Copy-Item -Path "Output/CleanGuard_App.exe.config" -Destination "$publishDir/CleanGuard.exe.config" -Force
          }

          if (Test-Path "Output/x86/SQLite.Interop.dll") {
            New-Item -ItemType Directory -Path "$publishDir/x86" -Force | Out-Null
            Copy-Item -Path "Output/x86/SQLite.Interop.dll" -Destination "$publishDir/x86/SQLite.Interop.dll" -Force
          }

          if (Test-Path "Output/x64/SQLite.Interop.dll") {
            New-Item -ItemType Directory -Path "$publishDir/x64" -Force | Out-Null
            Copy-Item -Path "Output/x64/SQLite.Interop.dll" -Destination "$publishDir/x64/SQLite.Interop.dll" -Force
          }

          if (Test-Path "Output/ICSharpCode.SharpZipLib.dll") {
            Copy-Item -Path "Output/ICSharpCode.SharpZipLib.dll" -Destination "$publishDir/ICSharpCode.SharpZipLib.dll" -Force
          }

      - name: Create ZIP package
        shell: pwsh
        run: |
          Compress-Archive -Path ./publish/* -DestinationPath ./CleanGuard.zip -Force

      - name: Get current date
        id: date
        shell: pwsh
        run: |
          $timestamp = Get-Date -Format "yyyyMMddHHmmss"
          "date=$timestamp" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append

      - name: Create Release and Upload Asset
        uses: softprops/action-gh-release@v2
        with:
          tag_name: release-${{ steps.date.outputs.date }}
          name: Release-${{ steps.date.outputs.date }}
          body: "Automated release with build artifacts"
          draft: false
          prerelease: false
          files: ./CleanGuard.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
