name: Build and Package

on:
  push:
    branches:
      - main
    tags:
      - '*'
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - rid: win32
            platform_target: x86
          - rid: win64
            platform_target: x64

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Setup NuGet
        uses: NuGet/setup-nuget@v2

      - name: Restore packages
        run: nuget restore Src/CleanGuard_App/packages.config -PackagesDirectory packages -NonInteractive

      - name: Build (${{ matrix.rid }})
        shell: pwsh
        run: |
          msbuild Src/CleanGuard_App/CleanGuard_App.csproj `
            /t:Rebuild `
            /p:Configuration=Release `
            /p:Platform="AnyCPU" `
            /p:PlatformTarget=${{ matrix.platform_target }}

      - name: Package (${{ matrix.rid }})
        id: package
        shell: pwsh
        run: |
          $timestamp = Get-Date -Format "yyyyMMdd-HHmmss"
          $stage = "artifacts/stage-${{ matrix.rid }}"
          New-Item -ItemType Directory -Path $stage -Force | Out-Null

          $singleExe = "Output/CleanGuard_App.exe"
          if (-not (Test-Path $singleExe)) {
            throw "Single-file exe not found: $singleExe"
          }

          Copy-Item -Path $singleExe -Destination "$stage/CleanGuard.exe" -Force

          $config = "Output/CleanGuard_App.exe.config"
          if (Test-Path $config) {
            Copy-Item -Path $config -Destination "$stage/CleanGuard.exe.config" -Force
          }

          if (Test-Path "Output/x86/SQLite.Interop.dll") {
            New-Item -ItemType Directory -Path "$stage/x86" -Force | Out-Null
            Copy-Item -Path "Output/x86/SQLite.Interop.dll" -Destination "$stage/x86/SQLite.Interop.dll" -Force
          }

          if (Test-Path "Output/x64/SQLite.Interop.dll") {
            New-Item -ItemType Directory -Path "$stage/x64" -Force | Out-Null
            Copy-Item -Path "Output/x64/SQLite.Interop.dll" -Destination "$stage/x64/SQLite.Interop.dll" -Force
          }

          $sharpZipLib = "Output/ICSharpCode.SharpZipLib.dll"
          if (Test-Path $sharpZipLib) {
            Copy-Item -Path $sharpZipLib -Destination "$stage/ICSharpCode.SharpZipLib.dll" -Force
          }

          $zipName = "CleanGuard-${{ matrix.rid }}-$timestamp.zip"
          $zipPath = "artifacts/$zipName"
          if (Test-Path $zipPath) { Remove-Item $zipPath -Force }
          Compress-Archive -Path "$stage/*" -DestinationPath $zipPath

          "zip_name=$zipName" >> $env:GITHUB_OUTPUT
          "zip_path=$zipPath" >> $env:GITHUB_OUTPUT

      - name: Upload artifact (${{ matrix.rid }})
        uses: actions/upload-artifact@v4
        with:
          name: package-${{ matrix.rid }}
          path: ${{ steps.package.outputs.zip_path }}
          if-no-files-found: error

  release:
    if: startsWith(github.ref, 'refs/tags/')
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download packaged artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-assets

      - name: Publish Release assets to tag
        uses: softprops/action-gh-release@v2
        with:
          files: release-assets/**/*.zip
          generate_release_notes: true
