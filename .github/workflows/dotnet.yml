name: Build and Package

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          # 定义 win32 (x86) 构建配置
          - rid: win32
            platform: x86
          # 定义 win64 (x64) 构建配置
          - rid: win64
            platform: x64

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Setup NuGet
        uses: NuGet/setup-nuget@v2

      # 关键修改：添加 -SolutionDirectory . 确保 packages 文件夹创建在根目录
      - name: Restore packages
        run: nuget restore Src/CleanGuard_App/CleanGuard_App.csproj -SolutionDirectory .

      # 编译步骤：显式指定 OutputPath，方便后续打包
      - name: Build (${{ matrix.rid }})
        run: |
          msbuild Src/CleanGuard_App/CleanGuard_App.csproj `
            /t:Rebuild `
            /p:Configuration=Release `
            /p:Platform="${{ matrix.platform }}" `
            /p:OutputPath="${{ github.workspace }}\BuildOutput\${{ matrix.rid }}"

      # 打包步骤：直接压缩上一步生成的 OutputPath 目录
      - name: Package (${{ matrix.rid }})
        shell: pwsh
        run: |
          $sourceDir = "${{ github.workspace }}\BuildOutput\${{ matrix.rid }}"
          $artifactName = "CleanGuard-${{ matrix.rid }}"
          $zipPath = "${{ github.workspace }}\$artifactName.zip"

          Write-Host "Packaging from: $sourceDir"
          
          # 检查目录是否存在
          if (-not (Test-Path $sourceDir)) {
            throw "Build output folder not found at: $sourceDir"
          }

          # 压缩文件
          Compress-Archive -Path "$sourceDir\*" -DestinationPath $zipPath -Force
          Write-Host "Created archive: $zipPath"

      - name: Upload artifact (${{ matrix.rid }})
        uses: actions/upload-artifact@v4
        with:
          name: CleanGuard-${{ matrix.rid }}
          path: CleanGuard-${{ matrix.rid }}.zip
          if-no-files-found: error
